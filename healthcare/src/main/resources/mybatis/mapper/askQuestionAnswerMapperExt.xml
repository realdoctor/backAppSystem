<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kanglian.healthcare.back.dal.dao.AskQuestionAnswerDao">
	<select id="getListByUserId" resultMap="BaseResultMap" parameterType="java.lang.Integer">
		select
		<include refid="columns"/>
		from ask_question_answer t
		where t.user_id = #{userId,jdbcType=INTEGER}
		order by t.add_time desc
	</select>
	
	<select id="getListByMessageId" resultMap="BaseResultMap" parameterType="java.lang.String">
		SELECT
			t.id,
			t.message_id,
			t.user_id,
			t.to_user,
			t.question,
			t.answer,
			t.status,
			t.add_time,
			t.last_update_dtime,
			u1.real_name AS patientRealName,
			u2.real_name AS doctorRealName,
			t2.src,
			t2.remark
		FROM
			ask_question_answer t
		LEFT JOIN upload_patient t2 ON t2.question_id=t.id
		LEFT JOIN user u1 ON u1.user_id=t.user_id
		LEFT JOIN user u2 ON u2.user_id=t.to_user
		WHERE message_id=#{messageId,jdbcType=VARCHAR}
		ORDER BY t.add_time desc
	</select>
	
	<!-- 分组后取出最新一条回复数据 -->
	<select id="frontList" resultMap="BaseResultMap" parameterType="com.easyway.business.framework.mybatis.query.ConditionQuery">
		SELECT
			t.id,
			t.message_id,
			t.user_id,
			t.to_user,
			t.question,
			t.answer,
			t.status,
			t.add_time,
			t.last_update_dtime,
			u1.real_name AS patientRealName,
			u2.real_name AS doctorRealName,
			t2.src,
			t2.remark
		FROM
			ask_question_answer t
		LEFT JOIN upload_patient t2 ON t2.question_id=t.id
		LEFT JOIN user u1 ON u1.user_id=t.user_id
		LEFT JOIN user u2 ON u2.user_id=t.to_user
		INNER JOIN (
			SELECT
				max(t.id) as id,
				COUNT(t.message_id) replyNum
			FROM
				ask_question_answer t
			WHERE t.answer IS NULL OR t.answer=''
			GROUP BY
				t.message_id
			<![CDATA[
			HAVING
				replyNum < 3
			]]>
			ORDER BY
				t.add_time DESC
		) t1 ON t.id = t1.id
		<include refid="conditionQuery.core" />
		order by
		<choose>
		<when test="paramMap.orderCol!=null">
		${paramMap.orderCol}
		</when>
		<otherwise>
		id desc
		</otherwise>
		</choose>
		<if test="paramMap.pageSize > 0">
		  limit #{paramMap.pageOffset},#{paramMap.pageSize}
		</if>
	</select>
	
	<!-- 患者超过三天未处理已回复列表 -->
	<select id="getListOverThreeday" resultMap="BaseResultMap">
		SELECT
		<include refid="columns"/>
		FROM ask_question_answer t
		WHERE
			(
			<![CDATA[
			t.answer IS NOT NULL AND t.answer <> '' AND datediff(now(), t.last_update_dtime) > 3 AND `status` = 1
			]]>
			)
		ORDER BY last_update_dtime DESC
	</select>
	
	<!-- 更新患者超过三天未处理，已回复列表状态 -->
	<update id="updateStatusOverThreeday">
		UPDATE ask_question_answer
		SET `status` = 2
		WHERE
			(
			<![CDATA[
			answer IS NOT NULL AND answer <> '' AND datediff(now(), last_update_dtime) > 3
			]]>
			)
	</update>
</mapper>
