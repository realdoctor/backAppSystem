<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kanglian.healthcare.back.dal.dao.UserInfoDao">
	<resultMap type="com.kanglian.healthcare.back.dal.pojo.UserInfo" id="BaseResultMapExt" extends="BaseResultMap">
		<result property="typeId" column="type_id" jdbcType="VARCHAR"/>
		<result property="realName" column="real_name" jdbcType="VARCHAR"/>
		<result property="originalImageUrl" column="pic" jdbcType="VARCHAR"/>
		<result property="imageUrl" column="thumbnail_pic" jdbcType="VARCHAR"/>
	</resultMap>
	
	<!-- 用户基本信息 -->
	<select id="getUserInfo" resultMap="BaseResultMapExt" parameterType="com.kanglian.healthcare.back.dal.pojo.User">
		SELECT
			t1.id,
			t1.org_code,
			t1.patient_id,
			t1.`name`,
			t1.sex_code,
			t1.birth_date,
			t1.abo_code,
			t1.rh_code,
			t1.marriage_code,
			t1.nationality_code,
			t1.card_type_code,
			t1.card_no,
			t1.drug_allergy_mark,
			t.user_id,
			t.real_name,
			t.mobile_phone,
			t2.pic,
			t2.thumbnail_pic,
			t3.type_id,
			t3.id_no
		FROM
			`user` t
		LEFT JOIN user_info t1 ON t.user_id = t1.user_id
		LEFT JOIN user_pic t2 ON t.user_id = t2.user_id
		LEFT JOIN user_identify t3 ON t1.user_id = t3.user_id
		<trim prefix="where" prefixOverrides="and|or">
			<choose>
				<when test="userId!=null">
					t.user_id = #{userId,jdbcType=INTEGER}
				</when>
				<when test="idNo!=null and idNo !=''">
					and t.id_no = #{idNo,jdbcType=VARCHAR}
				</when>
				<otherwise>
					and t.mobile_phone = #{mobilePhone,jdbcType=VARCHAR} 
				</otherwise>
			</choose>
		</trim>
	</select>
	
	<!-- 同步用户关联，挂关系 -->
	<update id="updateRelationship" parameterType="com.kanglian.healthcare.back.dal.pojo.User">
		UPDATE user_info
		SET user_id = #{userId,jdbcType=INTEGER}, last_update_dtime = NOW()
		<trim prefix="where" prefixOverrides="and|or">
			<choose>
				<when test="idNo!=null and idNo !=''">
					and id_no = #{idNo,jdbcType=VARCHAR}
				</when>
				<otherwise>
					and mobile_phone = #{mobilePhone,jdbcType=VARCHAR}
				</otherwise>
			</choose>
		</trim>
	</update>
</mapper>
